cscope 15 $HOME/pintos/src/threads -q 0000000506 0000043557
	@flags.h

1 #i‚de‡
THREADS_FLAGS_H


2 
	#THREADS_FLAGS_H


	)

5 
	#FLAG_MBS
 0x00000002

	)

6 
	#FLAG_IF
 0x00000200

	)

	@init.c

1 
	~"thªads/öô.h
"

2 
	~<c⁄sﬁe.h
>

3 
	~<debug.h
>

4 
	~<limôs.h
>

5 
	~<øndom.h
>

6 
	~<°ddef.h
>

7 
	~<°döt.h
>

8 
	~<°dio.h
>

9 
	~<°dlib.h
>

10 
	~<°rög.h
>

11 
	~"devi˚s/kbd.h
"

12 
	~"devi˚s/öput.h
"

13 
	~"devi˚s/£rül.h
"

14 
	~"devi˚s/timî.h
"

15 
	~"devi˚s/vga.h
"

16 
	~"devi˚s/πc.h
"

17 
	~"thªads/öãºu±.h
"

18 
	~"thªads/io.h
"

19 
	~"thªads/lﬂdî.h
"

20 
	~"thªads/mÆloc.h
"

21 
	~"thªads/∑Œoc.h
"

22 
	~"thªads/±e.h
"

23 
	~"thªads/thªad.h
"

24 #ifde‡
USERPROG


25 
	~"u£Ωrog/¥o˚ss.h
"

26 
	~"u£Ωrog/ex˚±i⁄.h
"

27 
	~"u£Ωrog/gdt.h
"

28 
	~"u£Ωrog/sysˇŒ.h
"

29 
	~"u£Ωrog/tss.h
"

31 
	~"ã°s/thªads/ã°s.h
"

33 #ifde‡
FILESYS


34 
	~"devi˚s/disk.h
"

35 
	~"fûesys/fûesys.h
"

36 
	~"fûesys/fsutû.h
"

40 
size_t
 
	gøm_∑ges
;

43 
uöt32_t
 *
	gba£_∑ge_dú
;

45 #ifde‡
FILESYS


47 
boﬁ
 
	gf‹m©_fûesys
;

51 
boﬁ
 
	gpowî_off_whí_d⁄e
;

54 
boﬁ
 
	gªboŸ_whí_d⁄e
;

56 
øm_öô
 ();

57 
∑gög_öô
 ();

59 **
ªad_comm™d_löe
 ();

60 **
∑r£_›ti⁄s
 (**
¨gv
);

61 
run_a˘i⁄s
 (**
¨gv
);

62 
ußge
 ();

64 
¥öt_°©s
 ();

67 
	$maö
 (Ë
NO_RETURN
;

71 
	$maö
 ()

73 **
¨gv
;

76 
	`øm_öô
 ();

79 
¨gv
 = 
	`ªad_comm™d_löe
 ();

80 
¨gv
 = 
	`∑r£_›ti⁄s
 (argv);

84 
	`thªad_öô
 ();

85 
	`c⁄sﬁe_öô
 ();

88 
	`¥ötf
 ("Pöto†boŸög wôh %'zu kB RAM...\n", 
øm_∑ges
 * 
PGSIZE
 / 1024);

91 
	`∑Œoc_öô
 ();

92 
	`mÆloc_öô
 ();

93 
	`∑gög_öô
 ();

96 #ifde‡
USERPROG


97 
	`tss_öô
 ();

98 
	`gdt_öô
 ();

102 
	`öå_öô
 ();

103 
	`timî_öô
 ();

104 
	`kbd_öô
 ();

105 
	`öput_öô
 ();

106 #ifde‡
USERPROG


107 
	`ex˚±i⁄_öô
 ();

108 
	`sysˇŒ_öô
 ();

112 
	`thªad_°¨t
 ();

113 
	`£rül_öô_queue
 ();

114 
	`timî_ˇlibøã
 ();

116 #ifde‡
FILESYS


118 
	`disk_öô
 ();

119 
	`fûesys_öô
 (
f‹m©_fûesys
);

122 
	`¥ötf
 ("Boot complete.\n");

125 
	`run_a˘i⁄s
 (
¨gv
);

128 i‡(
ªboŸ_whí_d⁄e
)

129 
	`ªboŸ
 ();

131 i‡(
powî_off_whí_d⁄e
)

132 
	`powî_off
 ();

133 
	`thªad_exô
 ();

134 
	}
}

138 
	$øm_öô
 ()

146 
_°¨t_bss
, 
_íd_bss
;

147 
	`mem£t
 (&
_°¨t_bss
, 0, &
_íd_bss
 - &_start_bss);

150 
øm_∑ges
 = *(
uöt32_t
 *Ë
	`±ov
 (
LOADER_RAM_PGS
);

151 
	}
}

163 
	$∑gög_öô
 ()

165 
uöt32_t
 *
pd
, *
±
;

166 
size_t
 
∑ge
;

167 
_°¨t
, 
_íd_kî√l_ãxt
;

169 
pd
 = 
ba£_∑ge_dú
 = 
	`∑Œoc_gë_∑ge
 (
PAL_ASSERT
 | 
PAL_ZERO
);

170 
±
 = 
NULL
;

171 
∑ge
 = 0;Öagê< 
øm_∑ges
;Öage++)

173 
uöçå_t
 
∑ddr
 = 
∑ge
 * 
PGSIZE
;

174 *
vaddr
 = 
	`±ov
 (
∑ddr
);

175 
size_t
 
pde_idx
 = 
	`pd_no
 (
vaddr
);

176 
size_t
 
±e_idx
 = 
	`±_no
 (
vaddr
);

177 
boﬁ
 
ö_kî√l_ãxt
 = &
_°¨t
 <
vaddr
 && vadd∏< &
_íd_kî√l_ãxt
;

179 i‡(
pd
[
pde_idx
] == 0)

181 
±
 = 
	`∑Œoc_gë_∑ge
 (
PAL_ASSERT
 | 
PAL_ZERO
);

182 
pd
[
pde_idx
] = 
	`pde_¸óã
 (
±
);

185 
±
[
±e_idx
] = 
	`±e_¸óã_kî√l
 (
vaddr
, !
ö_kî√l_ãxt
);

193 
asm
 vﬁ©ûê("mov»%0, %%¸3" : : "r" (
	`vt›
 (
ba£_∑ge_dú
)));

194 
	}
}

199 
	$ªad_comm™d_löe
 ()

201 *
¨gv
[
LOADER_ARGS_LEN
 / 2 + 1];

202 *
p
, *
íd
;

203 
¨gc
;

204 
i
;

206 
¨gc
 = *(
uöt32_t
 *Ë
	`±ov
 (
LOADER_ARG_CNT
);

207 
p
 = 
	`±ov
 (
LOADER_ARGS
);

208 
íd
 = 
p
 + 
LOADER_ARGS_LEN
;

209 
i
 = 0; i < 
¨gc
; i++)

211 i‡(
p
 >
íd
)

212 
	`PANIC
 ("commandÜineárguments overflow");

214 
¨gv
[
i
] = 
p
;

215 
p
 +
	`°∫Àn
 (p, 
íd
 -Ö) + 1;

217 
¨gv
[
¨gc
] = 
NULL
;

220 
	`¥ötf
 ("Kernel commandÜine:");

221 
i
 = 0; i < 
¨gc
; i++)

222 i‡(
	`°rchr
 (
¨gv
[
i
], ' 'Ë=
NULL
)

223 
	`¥ötf
 (" %s", 
¨gv
[
i
]);

225 
	`¥ötf
 (" '%s'", 
¨gv
[
i
]);

226 
	`¥ötf
 ("\n");

228  
¨gv
;

229 
	}
}

234 
	$∑r£_›ti⁄s
 (**
¨gv
)

236 ; *
¨gv
 !
NULL
 && **argv == '-';árgv++)

238 *
ßve_±r
;

239 *
«me
 = 
	`°πok_r
 (*
¨gv
, "=", &
ßve_±r
);

240 *
vÆue
 = 
	`°πok_r
 (
NULL
, "", &
ßve_±r
);

242 i‡(!
	`°rcmp
 (
«me
, "-h"))

243 
	`ußge
 ();

244 i‡(!
	`°rcmp
 (
«me
, "-q"))

245 
powî_off_whí_d⁄e
 = 
åue
;

246 i‡(!
	`°rcmp
 (
«me
, "-r"))

247 
ªboŸ_whí_d⁄e
 = 
åue
;

248 #ifde‡
FILESYS


249 i‡(!
	`°rcmp
 (
«me
, "-f"))

250 
f‹m©_fûesys
 = 
åue
;

252 i‡(!
	`°rcmp
 (
«me
, "-rs"))

253 
	`øndom_öô
 (
	`©oi
 (
vÆue
));

254 i‡(!
	`°rcmp
 (
«me
, "-mlfqs"))

255 
thªad_mlfqs
 = 
åue
;

256 #ifde‡
USERPROG


257 i‡(!
	`°rcmp
 (
«me
, "-ul"))

258 
u£r_∑ge_limô
 = 
	`©oi
 (
vÆue
);

261 
	`PANIC
 ("unknow¿›ti⁄ `%s' (u£ -h f‹ hñp)", 
«me
);

272 
	`øndom_öô
 (
	`πc_gë_time
 ());

274  
¨gv
;

275 
	}
}

279 
	$run_èsk
 (**
¨gv
)

281 c⁄° *
èsk
 = 
¨gv
[1];

283 
	`¥ötf
 ("Executög '%s':\n", 
èsk
);

284 #ifde‡
USERPROG


285 
	`¥o˚ss_waô
 (
	`¥o˚ss_execuã
 (
èsk
));

287 
	`run_ã°
 (
èsk
);

289 
	`¥ötf
 ("Executi⁄ o‡'%s' com∂ëe.\n", 
èsk
);

290 
	}
}

295 
	$run_a˘i⁄s
 (**
¨gv
)

298 
	sa˘i⁄


300 *
«me
;

301 
¨gc
;

302 (*
fun˘i⁄
Ë(**
¨gv
);

306 c⁄° 
a˘i⁄
 
a˘i⁄s
[] =

308 {"run", 2, 
run_èsk
},

309 #ifde‡
FILESYS


310 {"ls", 1, 
fsutû_ls
},

311 {"ˇt", 2, 
fsutû_ˇt
},

312 {"rm", 2, 
fsutû_rm
},

313 {"exåa˘", 1, 
fsutû_exåa˘
},

314 {"≠≥nd", 2, 
fsutû_≠≥nd
},

316 {
NULL
, 0, NULL},

319 *
¨gv
 !
NULL
)

321 c⁄° 
a˘i⁄
 *
a
;

322 
i
;

325 
a
 = 
a˘i⁄s
; ;á++)

326 i‡(
a
->
«me
 =
NULL
)

327 
	`PANIC
 ("unknow¿a˘i⁄ `%s' (u£ -h f‹ hñp)", *
¨gv
);

328 i‡(!
	`°rcmp
 (*
¨gv
, 
a
->
«me
))

332 
i
 = 1; i < 
a
->
¨gc
; i++)

333 i‡(
¨gv
[
i
] =
NULL
)

334 
	`PANIC
 ("a˘i⁄ `%s'Ñequúe†%dárgumít(s)", *
¨gv
, 
a
->
¨gc
 - 1);

337 
a
->
	`fun˘i⁄
 (
¨gv
);

338 
¨gv
 +
a
->
¨gc
;

341 
	}
}

346 
	$ußge
 ()

348 
	`¥ötf
 ("\nCommandÜine syntax: [OPTION...] [ACTION...]\n"

352 #ifde‡
USERPROG


357 #ifde‡
FILESYS


372 #ifde‡
USERPROG


376 
	`powî_off
 ();

377 
	}
}

380 
	#CONTROL_REG
 0x64

	)

384 
	$ªboŸ
 ()

386 
i
;

388 
	`¥ötf
 ("Rebooting...\n");

392 
i
 = 0; i < 100; i++)

394 
j
;

398 
j
 = 0; j < 0x10000; j++)

400 i‡((
	`öb
 (
CONTROL_REG
) & 0x02) == 0)

402 
	`timî_udñay
 (2);

405 
	`timî_udñay
 (50);

409 
	`outb
 (
CONTROL_REG
, 0xfe);

410 
	`timî_udñay
 (50);

412 
	}
}

417 
	$powî_off
 ()

419 c⁄° 
s
[] = "Shutdown";

420 c⁄° *
p
;

422 #ifde‡
FILESYS


423 
	`fûesys_d⁄e
 ();

426 
	`¥öt_°©s
 ();

428 
	`¥ötf
 ("Powering off...\n");

429 
	`£rül_Êush
 ();

431 
p
 = 
s
; *p != '\0';Ö++)

432 
	`outb
 (0x8900, *
p
);

433 
asm
 volatile ("cli; hlt" : : : "memory");

434 
	`¥ötf
 ("stillÑunning...\n");

436 
	}
}

440 
	$¥öt_°©s
 ()

442 
	`timî_¥öt_°©s
 ();

443 
	`thªad_¥öt_°©s
 ();

444 #ifde‡
FILESYS


445 
	`disk_¥öt_°©s
 ();

447 
	`c⁄sﬁe_¥öt_°©s
 ();

448 
	`kbd_¥öt_°©s
 ();

449 #ifde‡
USERPROG


450 
	`ex˚±i⁄_¥öt_°©s
 ();

452 
	}
}

	@init.h

1 #i‚de‡
THREADS_INIT_H


2 
	#THREADS_INIT_H


	)

4 
	~<debug.h
>

5 
	~<°dboﬁ.h
>

6 
	~<°ddef.h
>

7 
	~<°döt.h
>

10 
size_t
 
øm_∑ges
;

13 
uöt32_t
 *
ba£_∑ge_dú
;

16 
boﬁ
 
powî_off_whí_d⁄e
;

18 
	$powî_off
 (Ë
NO_RETURN
;

19 
	`ªboŸ
 ();

	@interrupt.c

1 
	~"thªads/öãºu±.h
"

2 
	~<debug.h
>

3 
	~<öây≥s.h
>

4 
	~<°döt.h
>

5 
	~<°dio.h
>

6 
	~"thªads/Êags.h
"

7 
	~"thªads/öå-°ubs.h
"

8 
	~"thªads/io.h
"

9 
	~"thªads/thªad.h
"

10 
	~"thªads/vaddr.h
"

11 
	~"devi˚s/timî.h
"

16 
	#PIC0_CTRL
 0x20

	)

17 
	#PIC0_DATA
 0x21

	)

18 
	#PIC1_CTRL
 0xa0

	)

19 
	#PIC1_DATA
 0xa1

	)

22 
	#INTR_CNT
 256

	)

28 
uöt64_t
 
	gidt
[
INTR_CNT
];

31 
öå_h™dÀr_func
 *
	göå_h™dÀrs
[
INTR_CNT
];

34 c⁄° *
	göå_«mes
[
INTR_CNT
];

43 
boﬁ
 
	gö_exã∫Æ_öå
;

44 
boﬁ
 
	gyõld_⁄_ªtu∫
;

47 
pic_öô
 ();

48 
pic_íd_of_öãºu±
 (
úq
);

51 
uöt64_t
 
make_öå_g©e
 ((*Ë(), 
d∂
);

52 
uöt64_t
 
	`make_å≠_g©e
 ((*Ë(), 
d∂
);

53 
ölöe
 
uöt64_t
 
	`make_idå_›î™d
 (
uöt16_t
 
limô
, *
ba£
);

56 
	`öå_h™dÀr
 (
öå_‰ame
 *
¨gs
);

59 
öå_Àvñ


60 
	$öå_gë_Àvñ
 ()

62 
uöt32_t
 
Êags
;

68 
asm
 vﬁ©ûê("pushÊ;Ö›»%0" : "=g" (
Êags
));

70  
Êags
 & 
FLAG_IF
 ? 
INTR_ON
 : 
INTR_OFF
;

71 
	}
}

75 
öå_Àvñ


76 
	$öå_£t_Àvñ
 (
öå_Àvñ
 
Àvñ
)

78  
Àvñ
 =
INTR_ON
 ? 
	`öå_íabÀ
 (Ë: 
	`öå_dißbÀ
 ();

79 
	}
}

82 
öå_Àvñ


83 
	$öå_íabÀ
 ()

85 
öå_Àvñ
 
ﬁd_Àvñ
 = 
	`öå_gë_Àvñ
 ();

86 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

92 
asm
 volatile ("sti");

94  
ﬁd_Àvñ
;

95 
	}
}

98 
öå_Àvñ


99 
	$öå_dißbÀ
 ()

101 
öå_Àvñ
 
ﬁd_Àvñ
 = 
	`öå_gë_Àvñ
 ();

106 
asm
 volatile ("cli" : : : "memory");

108  
ﬁd_Àvñ
;

109 
	}
}

113 
	$öå_öô
 ()

115 
uöt64_t
 
idå_›î™d
;

116 
i
;

119 
	`pic_öô
 ();

122 
i
 = 0; i < 
INTR_CNT
; i++)

123 
idt
[
i
] = 
	`make_öå_g©e
 (
öå_°ubs
[i], 0);

128 
idå_›î™d
 = 
	`make_idå_›î™d
 ( 
idt
 - 1, idt);

129 
asm
 vﬁ©ûê("lidà%0" : : "m" (
idå_›î™d
));

132 
i
 = 0; i < 
INTR_CNT
; i++)

133 
öå_«mes
[
i
] = "unknown";

134 
öå_«mes
[0] = "#DE Divide Error";

135 
öå_«mes
[1] = "#DB Debug Exception";

136 
öå_«mes
[2] = "NMI Interrupt";

137 
öå_«mes
[3] = "#BP Breakpoint Exception";

138 
öå_«mes
[4] = "#OF Overflow Exception";

139 
öå_«mes
[5] = "#BR BOUND Range Exceeded Exception";

140 
öå_«mes
[6] = "#UD Invalid Opcode Exception";

141 
öå_«mes
[7] = "#NM Device Not Available Exception";

142 
öå_«mes
[8] = "#DF Double Fault Exception";

143 
öå_«mes
[9] = "Coprocessor Segment Overrun";

144 
öå_«mes
[10] = "#TS Invalid TSS Exception";

145 
öå_«mes
[11] = "#NP Segment Not Present";

146 
öå_«mes
[12] = "#SS Stack Fault Exception";

147 
öå_«mes
[13] = "#GP General Protection Exception";

148 
öå_«mes
[14] = "#PF Page-Fault Exception";

149 
öå_«mes
[16] = "#MF x87 FPU Floating-Point Error";

150 
öå_«mes
[17] = "#AC Alignment Check Exception";

151 
öå_«mes
[18] = "#MC Machine-Check Exception";

152 
öå_«mes
[19] = "#XF SIMD Floating-Point Exception";

153 
	}
}

160 
	$ªgi°î_h™dÀr
 (
uöt8_t
 
vec_no
, 
d∂
, 
öå_Àvñ
 
Àvñ
,

161 
öå_h™dÀr_func
 *
h™dÀr
, c⁄° *
«me
)

163 
	`ASSERT
 (
öå_h™dÀrs
[
vec_no
] =
NULL
);

164 i‡(
Àvñ
 =
INTR_ON
)

165 
idt
[
vec_no
] = 
	`make_å≠_g©e
 (
öå_°ubs
[vec_no], 
d∂
);

167 
idt
[
vec_no
] = 
	`make_öå_g©e
 (
öå_°ubs
[vec_no], 
d∂
);

168 
öå_h™dÀrs
[
vec_no
] = 
h™dÀr
;

169 
öå_«mes
[
vec_no
] = 
«me
;

170 
	}
}

176 
	$öå_ªgi°î_ext
 (
uöt8_t
 
vec_no
, 
öå_h™dÀr_func
 *
h™dÀr
,

177 c⁄° *
«me
)

179 
	`ASSERT
 (
vec_no
 >= 0x20 && vec_no <= 0x2f);

180 
	`ªgi°î_h™dÀr
 (
vec_no
, 0, 
INTR_OFF
, 
h™dÀr
, 
«me
);

181 
	}
}

197 
	$öå_ªgi°î_öt
 (
uöt8_t
 
vec_no
, 
d∂
, 
öå_Àvñ
 
Àvñ
,

198 
öå_h™dÀr_func
 *
h™dÀr
, c⁄° *
«me
)

200 
	`ASSERT
 (
vec_no
 < 0x20 || vec_no > 0x2f);

201 
	`ªgi°î_h™dÀr
 (
vec_no
, 
d∂
, 
Àvñ
, 
h™dÀr
, 
«me
);

202 
	}
}

206 
boﬁ


207 
	$öå_c⁄ãxt
 ()

209  
ö_exã∫Æ_öå
;

210 
	}
}

217 
	$öå_yõld_⁄_ªtu∫
 ()

219 
	`ASSERT
 (
	`öå_c⁄ãxt
 ());

220 
yõld_⁄_ªtu∫
 = 
åue
;

221 
	}
}

233 
	$pic_öô
 ()

236 
	`outb
 (
PIC0_DATA
, 0xff);

237 
	`outb
 (
PIC1_DATA
, 0xff);

240 
	`outb
 (
PIC0_CTRL
, 0x11);

241 
	`outb
 (
PIC0_DATA
, 0x20);

242 
	`outb
 (
PIC0_DATA
, 0x04);

243 
	`outb
 (
PIC0_DATA
, 0x01);

246 
	`outb
 (
PIC1_CTRL
, 0x11);

247 
	`outb
 (
PIC1_DATA
, 0x28);

248 
	`outb
 (
PIC1_DATA
, 0x02);

249 
	`outb
 (
PIC1_DATA
, 0x01);

252 
	`outb
 (
PIC0_DATA
, 0x00);

253 
	`outb
 (
PIC1_DATA
, 0x00);

254 
	}
}

260 
	$pic_íd_of_öãºu±
 (
úq
)

262 
	`ASSERT
 (
úq
 >= 0x20 && irq < 0x30);

265 
	`outb
 (0x20, 0x20);

268 i‡(
úq
 >= 0x28)

269 
	`outb
 (0xa0, 0x20);

270 
	}
}

288 
uöt64_t


289 
make_g©e
 ((*
fun˘i⁄
Ë(), 
d∂
, 
ty≥
)

291 
uöt32_t
 
e0
, 
e1
;

293 
	`ASSERT
 (
fun˘i⁄
 !
NULL
);

294 
	`ASSERT
 (
d∂
 >= 0 && dpl <= 3);

295 
	`ASSERT
 (
ty≥
 >= 0 &&Åype <= 15);

297 
e0
 = (((
uöt32_t
Ë
fun˘i⁄
 & 0xffff)

298 | (
SEL_KCSEG
 << 16));

300 
e1
 = (((
uöt32_t
Ë
fun˘i⁄
 & 0xffff0000)

302 | ((
uöt32_t
Ë
d∂
 << 13)

304 | ((
uöt32_t
Ë
ty≥
 << 8));

306  
e0
 | ((
uöt64_t
Ë
e1
 << 32);

307 
	}
}

311 
uöt64_t


312 
make_öå_g©e
 ((*
fun˘i⁄
Ë(), 
d∂
)

314  
	`make_g©e
 (
fun˘i⁄
, 
d∂
, 14);

315 
	}
}

319 
uöt64_t


320 
make_å≠_g©e
 ((*
fun˘i⁄
Ë(), 
d∂
)

322  
	`make_g©e
 (
fun˘i⁄
, 
d∂
, 15);

323 
	}
}

327 
ölöe
 
uöt64_t


328 
	$make_idå_›î™d
 (
uöt16_t
 
limô
, *
ba£
)

330  
limô
 | ((
uöt64_t
Ë(
uöt32_t
Ë
ba£
 << 16);

331 
	}
}

340 
	$öå_h™dÀr
 (
öå_‰ame
 *
‰ame
)

342 
boﬁ
 
exã∫Æ
;

343 
öå_h™dÀr_func
 *
h™dÀr
;

349 
exã∫Æ
 = 
‰ame
->
vec_no
 >= 0x20 && frame->vec_no < 0x30;

350 i‡(
exã∫Æ
)

352 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

353 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

355 
ö_exã∫Æ_öå
 = 
åue
;

356 
yõld_⁄_ªtu∫
 = 
Ál£
;

360 
h™dÀr
 = 
öå_h™dÀrs
[
‰ame
->
vec_no
];

361 i‡(
h™dÀr
 !
NULL
)

362 
	`h™dÀr
 (
‰ame
);

363 i‡(
‰ame
->
vec_no
 == 0x27 || frame->vec_no == 0x2f)

373 
	`öå_dump_‰ame
 (
‰ame
);

374 
	`PANIC
 ("Unexpected interrupt");

378 i‡(
exã∫Æ
)

380 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

381 
	`ASSERT
 (
	`öå_c⁄ãxt
 ());

383 
ö_exã∫Æ_öå
 = 
Ál£
;

384 
	`pic_íd_of_öãºu±
 (
‰ame
->
vec_no
);

386 i‡(
yõld_⁄_ªtu∫
)

387 
	`thªad_yõld
 ();

389 
	}
}

393 
	$öå_dump_‰ame
 (c⁄° 
öå_‰ame
 *
f
)

395 
uöt32_t
 
¸2
;

402 
	`asm
 ("mov»%%¸2, %0" : "Ù" (
¸2
));

404 
	`¥ötf
 ("Interrupt %#04x (%s)átÉip=%p\n",

405 
f
->
vec_no
, 
öå_«mes
[f->vec_no], f->
eù
);

406 
	`¥ötf
 (" cr2=%08"
PRIx32
"Éº‹=%08"PRIx32"\n", 
¸2
, 
f
->
îr‹_code
);

407 
	`¥ötf
 ("Éax=%08"
PRIx32
"Ébx=%08"PRIx32"Écx=%08"PRIx32"Édx=%08"PRIx32"\n",

408 
f
->
óx
, f->
ebx
, f->
ecx
, f->
edx
);

409 
	`¥ötf
 ("Ési=%08"
PRIx32
"Édi=%08"PRIx32"Ésp=%08"PRIx32"Ébp=%08"PRIx32"\n",

410 
f
->
esi
, f->
edi
, (
uöt32_t
Ëf->
e•
, f->
ebp
);

411 
	`¥ötf
 (" cs=%04"
PRIx16
" ds=%04"PRIx16"És=%04"PRIx16" ss=%04"PRIx16"\n",

412 
f
->
cs
, f->
ds
, f->
es
, f->
ss
);

413 
	}
}

417 
	$öå_«me
 (
uöt8_t
 
vec
)

419  
öå_«mes
[
vec
];

420 
	}
}

	@interrupt.h

1 #i‚de‡
THREADS_INTERRUPT_H


2 
	#THREADS_INTERRUPT_H


	)

4 
	~<°dboﬁ.h
>

5 
	~<°döt.h
>

8 
	eöå_Àvñ


10 
	mINTR_OFF
,

11 
	mINTR_ON


14 
öå_Àvñ
 
öå_gë_Àvñ
 ();

15 
öå_Àvñ
 
öå_£t_Àvñ
 (intr_level);

16 
öå_Àvñ
 
öå_íabÀ
 ();

17 
öå_Àvñ
 
öå_dißbÀ
 ();

20 
	söå_‰ame


24 
uöt32_t
 
	medi
;

25 
uöt32_t
 
	mesi
;

26 
uöt32_t
 
	mebp
;

27 
uöt32_t
 
	me•_dummy
;

28 
uöt32_t
 
	mebx
;

29 
uöt32_t
 
	medx
;

30 
uöt32_t
 
	mecx
;

31 
uöt32_t
 
	móx
;

32 
uöt16_t
 
	mgs
, :16;

33 
uöt16_t
 
	mfs
, :16;

34 
uöt16_t
 
	mes
, :16;

35 
uöt16_t
 
	mds
, :16;

38 
uöt32_t
 
	mvec_no
;

43 
uöt32_t
 
	mîr‹_code
;

47 *
	m‰ame_poöãr
;

51 (*
	meù
) ();

52 
uöt16_t
 
	mcs
, :16;

53 
uöt32_t
 
	meÊags
;

54 *
	me•
;

55 
uöt16_t
 
	mss
, :16;

58 
	töå_h™dÀr_func
 (
	töå_‰ame
 *);

60 
öå_öô
 ();

61 
öå_ªgi°î_ext
 (
uöt8_t
 
vec
, 
öå_h™dÀr_func
 *, c⁄° *
«me
);

62 
öå_ªgi°î_öt
 (
uöt8_t
 
vec
, 
d∂
, 
öå_Àvñ
,

63 
öå_h™dÀr_func
 *, c⁄° *
«me
);

64 
boﬁ
 
öå_c⁄ãxt
 ();

65 
öå_yõld_⁄_ªtu∫
 ();

67 
öå_dump_‰ame
 (c⁄° 
öå_‰ame
 *);

68 c⁄° *
öå_«me
 (
uöt8_t
 
vec
);

	@intr-stubs.h

1 #i‚de‡
THREADS_INTR_STUBS_H


2 
	#THREADS_INTR_STUBS_H


	)

13 
	töå_°ub_func
 ();

14 
öå_°ub_func
 *
öå_°ubs
[256];

17 
öå_exô
 ();

	@io.h

41 #i‚de‡
THREADS_IO_H


42 
	#THREADS_IO_H


	)

44 
	~<°ddef.h
>

45 
	~<°döt.h
>

48 
ölöe
 
uöt8_t


49 
	$öb
 (
uöt16_t
 
p‹t
)

52 
uöt8_t
 
d©a
;

53 
asm
 vﬁ©ûê("öb %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

54  
d©a
;

55 
	}
}

59 
ölöe
 

60 
	$ösb
 (
uöt16_t
 
p‹t
, *
addr
, 
size_t
 
˙t
)

63 
asm
 volatile ("cld;Ñepne; insb"

64 : "=D" (
addr
), "=c" (
˙t
)

65 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

67 
	}
}

70 
ölöe
 
uöt16_t


71 
	$öw
 (
uöt16_t
 
p‹t
)

73 
uöt16_t
 
d©a
;

75 
asm
 vﬁ©ûê("öw %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

76  
d©a
;

77 
	}
}

81 
ölöe
 

82 
	$ösw
 (
uöt16_t
 
p‹t
, *
addr
, 
size_t
 
˙t
)

85 
asm
 volatile ("cld;Ñepne; insw"

86 : "=D" (
addr
), "=c" (
˙t
)

87 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

89 
	}
}

92 
ölöe
 
uöt32_t


93 
	$öl
 (
uöt16_t
 
p‹t
)

96 
uöt32_t
 
d©a
;

97 
asm
 vﬁ©ûê("ö»%w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

98  
d©a
;

99 
	}
}

103 
ölöe
 

104 
	$ö¶
 (
uöt16_t
 
p‹t
, *
addr
, 
size_t
 
˙t
)

107 
asm
 volatile ("cld;Ñepne; insl"

108 : "=D" (
addr
), "=c" (
˙t
)

109 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

111 
	}
}

114 
ölöe
 

115 
	$outb
 (
uöt16_t
 
p‹t
, 
uöt8_t
 
d©a
)

118 
asm
 vﬁ©ûê("outb %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

119 
	}
}

123 
ölöe
 

124 
	$outsb
 (
uöt16_t
 
p‹t
, c⁄° *
addr
, 
size_t
 
˙t
)

127 
asm
 volatile ("cld;Ñepne; outsb"

128 : "=S" (
addr
), "=c" (
˙t
)

129 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

131 
	}
}

134 
ölöe
 

135 
	$outw
 (
uöt16_t
 
p‹t
, uöt16_à
d©a
)

138 
asm
 vﬁ©ûê("outw %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

139 
	}
}

143 
ölöe
 

144 
	$outsw
 (
uöt16_t
 
p‹t
, c⁄° *
addr
, 
size_t
 
˙t
)

147 
asm
 volatile ("cld;Ñepne; outsw"

148 : "=S" (
addr
), "=c" (
˙t
)

149 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

151 
	}
}

154 
ölöe
 

155 
	$oué
 (
uöt16_t
 
p‹t
, 
uöt32_t
 
d©a
)

158 
asm
 vﬁ©ûê("oué %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

159 
	}
}

163 
ölöe
 

164 
	$out¶
 (
uöt16_t
 
p‹t
, c⁄° *
addr
, 
size_t
 
˙t
)

167 
asm
 volatile ("cld;Ñepne; outsl"

168 : "=S" (
addr
), "=c" (
˙t
)

169 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

171 
	}
}

	@loader.h

1 #i‚de‡
THREADS_LOADER_H


2 
	#THREADS_LOADER_H


	)

5 
	#LOADER_BASE
 0x7c00

	)

6 
	#LOADER_END
 0x7e00

	)

9 
	#LOADER_KERN_BASE
 0x100000

	)

18 
	#LOADER_PHYS_BASE
 0xc0000000

	)

21 
	#LOADER_SIG
 (
LOADER_END
 - 
LOADER_SIG_LEN
Ë

	)

22 
	#LOADER_ARGS
 (
LOADER_SIG
 - 
LOADER_ARGS_LEN
Ë

	)

23 
	#LOADER_ARG_CNT
 (
LOADER_ARGS
 - 
LOADER_ARG_CNT_LEN
Ë

	)

24 
	#LOADER_RAM_PGS
 (
LOADER_ARG_CNT
 - 
LOADER_RAM_PGS_LEN
Ë

	)

27 
	#LOADER_SIG_LEN
 2

	)

28 
	#LOADER_ARGS_LEN
 128

	)

29 
	#LOADER_ARG_CNT_LEN
 4

	)

30 
	#LOADER_RAM_PGS_LEN
 4

	)

34 
	#SEL_NULL
 0x00

	)

35 
	#SEL_KCSEG
 0x08

	)

36 
	#SEL_KDSEG
 0x10

	)

	@malloc.c

1 
	~"thªads/mÆloc.h
"

2 
	~<debug.h
>

3 
	~<li°.h
>

4 
	~<round.h
>

5 
	~<°döt.h
>

6 
	~<°dio.h
>

7 
	~<°rög.h
>

8 
	~"thªads/∑Œoc.h
"

9 
	~"thªads/synch.h
"

10 
	~"thªads/vaddr.h
"

38 
	sdesc


40 
size_t
 
	mblock_size
;

41 
size_t
 
	mblocks_≥r_¨ía
;

42 
li°
 
	m‰ì_li°
;

43 
lock
 
	mlock
;

47 
	#ARENA_MAGIC
 0x9a548ìd

	)

50 
	s¨ía


52 
	mmagic
;

53 
desc
 *
	mdesc
;

54 
size_t
 
	m‰ì_˙t
;

58 
	sblock


60 
li°_ñem
 
	m‰ì_ñem
;

64 
desc
 
	gdescs
[10];

65 
size_t
 
	gdesc_˙t
;

67 
¨ía
 *
block_to_¨ía
 (
block
 *);

68 
block
 *
¨ía_to_block
 (
¨ía
 *, 
size_t
 
idx
);

72 
	$mÆloc_öô
 ()

74 
size_t
 
block_size
;

76 
block_size
 = 16; block_sizê< 
PGSIZE
 / 2; block_size *= 2)

78 
desc
 *
d
 = &
descs
[
desc_˙t
++];

79 
	`ASSERT
 (
desc_˙t
 < 
descs
 /  *descs);

80 
d
->
block_size
 = block_size;

81 
d
->
blocks_≥r_¨ía
 = (
PGSIZE
 -  (
¨ía
)Ë/ 
block_size
;

82 
	`li°_öô
 (&
d
->
‰ì_li°
);

83 
	`lock_öô
 (&
d
->
lock
);

85 
	}
}

90 
	$mÆloc
 (
size_t
 
size
)

92 
desc
 *
d
;

93 
block
 *
b
;

94 
¨ía
 *
a
;

97 i‡(
size
 == 0)

98  
NULL
;

102 
d
 = 
descs
; d < desc†+ 
desc_˙t
; d++)

103 i‡(
d
->
block_size
 >
size
)

105 i‡(
d
 =
descs
 + 
desc_˙t
)

109 
size_t
 
∑ge_˙t
 = 
	`DIV_ROUND_UP
 (
size
 +  *
a
, 
PGSIZE
);

110 
a
 = 
	`∑Œoc_gë_mu…ùÀ
 (0, 
∑ge_˙t
);

111 i‡(
a
 =
NULL
)

112  
NULL
;

116 
a
->
magic
 = 
ARENA_MAGIC
;

117 
a
->
desc
 = 
NULL
;

118 
a
->
‰ì_˙t
 = 
∑ge_˙t
;

119  
a
 + 1;

122 
	`lock_acquúe
 (&
d
->
lock
);

125 i‡(
	`li°_em±y
 (&
d
->
‰ì_li°
))

127 
size_t
 
i
;

130 
a
 = 
	`∑Œoc_gë_∑ge
 (0);

131 i‡(
a
 =
NULL
)

133 
	`lock_ªÀa£
 (&
d
->
lock
);

134  
NULL
;

138 
a
->
magic
 = 
ARENA_MAGIC
;

139 
a
->
desc
 = 
d
;

140 
a
->
‰ì_˙t
 = 
d
->
blocks_≥r_¨ía
;

141 
i
 = 0; i < 
d
->
blocks_≥r_¨ía
; i++)

143 
block
 *
b
 = 
	`¨ía_to_block
 (
a
, 
i
);

144 
	`li°_push_back
 (&
d
->
‰ì_li°
, &
b
->
‰ì_ñem
);

149 
b
 = 
	`li°_íåy
 (
	`li°_p›_‰⁄t
 (&
d
->
‰ì_li°
), 
block
, 
‰ì_ñem
);

150 
a
 = 
	`block_to_¨ía
 (
b
);

151 
a
->
‰ì_˙t
--;

152 
	`lock_ªÀa£
 (&
d
->
lock
);

153  
b
;

154 
	}
}

159 
	$ˇŒoc
 (
size_t
 
a
, size_à
b
)

161 *
p
;

162 
size_t
 
size
;

165 
size
 = 
a
 * 
b
;

166 i‡(
size
 < 
a
 || sizê< 
b
)

167  
NULL
;

170 
p
 = 
	`mÆloc
 (
size
);

171 i‡(
p
 !
NULL
)

172 
	`mem£t
 (
p
, 0, 
size
);

174  
p
;

175 
	}
}

178 
size_t


179 
	$block_size
 (*
block
)

181 
block
 *
b
 = block;

182 
¨ía
 *
a
 = 
	`block_to_¨ía
 (
b
);

183 
desc
 *
d
 = 
a
->desc;

185  
d
 !
NULL
 ? d->
block_size
 : 
PGSIZE
 * 
a
->
‰ì_˙t
 - 
	`pg_ofs
 (
block
);

186 
	}
}

195 
	$ªÆloc
 (*
ﬁd_block
, 
size_t
 
√w_size
)

197 i‡(
√w_size
 == 0)

199 
	`‰ì
 (
ﬁd_block
);

200  
NULL
;

204 *
√w_block
 = 
	`mÆloc
 (
√w_size
);

205 i‡(
ﬁd_block
 !
NULL
 && 
√w_block
 != NULL)

207 
size_t
 
ﬁd_size
 = 
	`block_size
 (
ﬁd_block
);

208 
size_t
 
mö_size
 = 
√w_size
 < 
ﬁd_size
 ?Çew_size : old_size;

209 
	`mem˝y
 (
√w_block
, 
ﬁd_block
, 
mö_size
);

210 
	`‰ì
 (
ﬁd_block
);

212  
√w_block
;

214 
	}
}

219 
	$‰ì
 (*
p
)

221 i‡(
p
 !
NULL
)

223 
block
 *
b
 = 
p
;

224 
¨ía
 *
a
 = 
	`block_to_¨ía
 (
b
);

225 
desc
 *
d
 = 
a
->desc;

227 i‡(
d
 !
NULL
)

231 #i‚de‡
NDEBUG


233 
	`mem£t
 (
b
, 0xcc, 
d
->
block_size
);

236 
	`lock_acquúe
 (&
d
->
lock
);

239 
	`li°_push_‰⁄t
 (&
d
->
‰ì_li°
, &
b
->
‰ì_ñem
);

242 i‡(++
a
->
‰ì_˙t
 >
d
->
blocks_≥r_¨ía
)

244 
size_t
 
i
;

246 
	`ASSERT
 (
a
->
‰ì_˙t
 =
d
->
blocks_≥r_¨ía
);

247 
i
 = 0; i < 
d
->
blocks_≥r_¨ía
; i++)

249 
block
 *
b
 = 
	`¨ía_to_block
 (
a
, 
i
);

250 
	`li°_ªmove
 (&
b
->
‰ì_ñem
);

252 
	`∑Œoc_‰ì_∑ge
 (
a
);

255 
	`lock_ªÀa£
 (&
d
->
lock
);

260 
	`∑Œoc_‰ì_mu…ùÀ
 (
a
,á->
‰ì_˙t
);

264 
	}
}

267 
¨ía
 *

268 
	$block_to_¨ía
 (
block
 *
b
)

270 
¨ía
 *
a
 = 
	`pg_round_down
 (
b
);

273 
	`ASSERT
 (
a
 !
NULL
);

274 
	`ASSERT
 (
a
->
magic
 =
ARENA_MAGIC
);

277 
	`ASSERT
 (
a
->
desc
 =
NULL


278 || (
	`pg_ofs
 (
b
Ë-  *
a
Ë%á->
desc
->
block_size
 == 0);

279 
	`ASSERT
 (
a
->
desc
 !
NULL
 || 
	`pg_ofs
 (
b
) ==  *a);

281  
a
;

282 
	}
}

285 
block
 *

286 
	$¨ía_to_block
 (
¨ía
 *
a
, 
size_t
 
idx
)

288 
	`ASSERT
 (
a
 !
NULL
);

289 
	`ASSERT
 (
a
->
magic
 =
ARENA_MAGIC
);

290 
	`ASSERT
 (
idx
 < 
a
->
desc
->
blocks_≥r_¨ía
);

291  (
block
 *Ë((
uöt8_t
 *Ë
a


292 +  *
a


293 + 
idx
 * 
a
->
desc
->
block_size
);

294 
	}
}

	@malloc.h

1 #i‚de‡
THREADS_MALLOC_H


2 
	#THREADS_MALLOC_H


	)

4 
	~<debug.h
>

5 
	~<°ddef.h
>

7 
mÆloc_öô
 ();

8 *
	$mÆloc
 (
size_t
Ë
	`__©åibuã__
 ((
mÆloc
));

9 *
	$ˇŒoc
 (
size_t
, size_tË
	`__©åibuã__
 ((
mÆloc
));

10 *
	`ªÆloc
 (*, 
size_t
);

11 
	`‰ì
 (*);

	@palloc.c

1 
	~"thªads/∑Œoc.h
"

2 
	~<bôm≠.h
>

3 
	~<debug.h
>

4 
	~<öây≥s.h
>

5 
	~<round.h
>

6 
	~<°ddef.h
>

7 
	~<°döt.h
>

8 
	~<°dio.h
>

9 
	~<°rög.h
>

10 
	~"thªads/öô.h
"

11 
	~"thªads/lﬂdî.h
"

12 
	~"thªads/synch.h
"

13 
	~"thªads/vaddr.h
"

30 
	spoﬁ


32 
lock
 
	mlock
;

33 
bôm≠
 *
	mu£d_m≠
;

34 
uöt8_t
 *
	mba£
;

38 
poﬁ
 
	gkî√l_poﬁ
, 
	gu£r_poﬁ
;

41 
size_t
 
	gu£r_∑ge_limô
 = 
SIZE_MAX
;

43 
öô_poﬁ
 (
poﬁ
 *, *
ba£
, 
size_t
 
∑ge_˙t
,

44 c⁄° *
«me
);

45 
boﬁ
 
∑ge_‰om_poﬁ
 (c⁄° 
poﬁ
 *, *
∑ge
);

49 
	$∑Œoc_öô
 ()

53 
_íd
;

56 
uöt8_t
 *
‰ì_°¨t
 = 
	`pg_round_up
 (&
_íd
);

57 
uöt8_t
 *
‰ì_íd
 = 
	`±ov
 (
øm_∑ges
 * 
PGSIZE
);

58 
size_t
 
‰ì_∑ges
 = (
‰ì_íd
 - 
‰ì_°¨t
Ë/ 
PGSIZE
;

59 
size_t
 
u£r_∑ges
 = 
‰ì_∑ges
 / 2;

60 
size_t
 
kî√l_∑ges
;

61 i‡(
u£r_∑ges
 > 
u£r_∑ge_limô
)

62 
u£r_∑ges
 = 
u£r_∑ge_limô
;

63 
kî√l_∑ges
 = 
‰ì_∑ges
 - 
u£r_∑ges
;

66 
	`öô_poﬁ
 (&
kî√l_poﬁ
, 
‰ì_°¨t
, 
kî√l_∑ges
, "kernelÖool");

67 
	`öô_poﬁ
 (&
u£r_poﬁ
, 
‰ì_°¨t
 + 
kî√l_∑ges
 * 
PGSIZE
,

68 
u£r_∑ges
, "userÖool");

69 
	}
}

78 
	$∑Œoc_gë_mu…ùÀ
 (
∑Œoc_Êags
 
Êags
, 
size_t
 
∑ge_˙t
)

80 
poﬁ
 *poﬁ = 
Êags
 & 
PAL_USER
 ? &
u£r_poﬁ
 : &
kî√l_poﬁ
;

81 *
∑ges
;

82 
size_t
 
∑ge_idx
;

84 i‡(
∑ge_˙t
 == 0)

85  
NULL
;

87 
	`lock_acquúe
 (&
poﬁ
->
lock
);

88 
∑ge_idx
 = 
	`bôm≠_sˇn_™d_Êù
 (
poﬁ
->
u£d_m≠
, 0, 
∑ge_˙t
, 
Ál£
);

89 
	`lock_ªÀa£
 (&
poﬁ
->
lock
);

91 i‡(
∑ge_idx
 !
BITMAP_ERROR
)

92 
∑ges
 = 
poﬁ
->
ba£
 + 
PGSIZE
 * 
∑ge_idx
;

94 
∑ges
 = 
NULL
;

96 i‡(
∑ges
 !
NULL
)

98 i‡(
Êags
 & 
PAL_ZERO
)

99 
	`mem£t
 (
∑ges
, 0, 
PGSIZE
 * 
∑ge_˙t
);

103 i‡(
Êags
 & 
PAL_ASSERT
)

104 
	`PANIC
 ("palloc_get: out ofÖages");

107  
∑ges
;

108 
	}
}

118 
	$∑Œoc_gë_∑ge
 (
∑Œoc_Êags
 
Êags
)

120  
	`∑Œoc_gë_mu…ùÀ
 (
Êags
, 1);

121 
	}
}

125 
	$∑Œoc_‰ì_mu…ùÀ
 (*
∑ges
, 
size_t
 
∑ge_˙t
)

127 
poﬁ
 *pool;

128 
size_t
 
∑ge_idx
;

130 
	`ASSERT
 (
	`pg_ofs
 (
∑ges
) == 0);

131 i‡(
∑ges
 =
NULL
 || 
∑ge_˙t
 == 0)

134 i‡(
	`∑ge_‰om_poﬁ
 (&
kî√l_poﬁ
, 
∑ges
))

135 
poﬁ
 = &
kî√l_poﬁ
;

136 i‡(
	`∑ge_‰om_poﬁ
 (&
u£r_poﬁ
, 
∑ges
))

137 
poﬁ
 = &
u£r_poﬁ
;

139 
	`NOT_REACHED
 ();

141 
∑ge_idx
 = 
	`pg_no
 (
∑ges
Ë-Ög_nÿ(
poﬁ
->
ba£
);

143 #i‚de‡
NDEBUG


144 
	`mem£t
 (
∑ges
, 0xcc, 
PGSIZE
 * 
∑ge_˙t
);

147 
	`ASSERT
 (
	`bôm≠_Æl
 (
poﬁ
->
u£d_m≠
, 
∑ge_idx
, 
∑ge_˙t
));

148 
	`bôm≠_£t_mu…ùÀ
 (
poﬁ
->
u£d_m≠
, 
∑ge_idx
, 
∑ge_˙t
, 
Ál£
);

149 
	}
}

153 
	$∑Œoc_‰ì_∑ge
 (*
∑ge
)

155 
	`∑Œoc_‰ì_mu…ùÀ
 (
∑ge
, 1);

156 
	}
}

161 
	$öô_poﬁ
 (
poﬁ
 *
p
, *
ba£
, 
size_t
 
∑ge_˙t
, c⁄° *
«me
)

166 
size_t
 
bm_∑ges
 = 
	`DIV_ROUND_UP
 (
	`bôm≠_buf_size
 (
∑ge_˙t
), 
PGSIZE
);

167 i‡(
bm_∑ges
 > 
∑ge_˙t
)

168 
	`PANIC
 ("NŸÉnough mem‹y i¿%†f‹ bôm≠.", 
«me
);

169 
∑ge_˙t
 -
bm_∑ges
;

171 
	`¥ötf
 ("%zuÖage†avaûabÀ i¿%s.\n", 
∑ge_˙t
, 
«me
);

174 
	`lock_öô
 (&
p
->
lock
);

175 
p
->
u£d_m≠
 = 
	`bôm≠_¸óã_ö_buf
 (
∑ge_˙t
, 
ba£
, 
bm_∑ges
 * 
PGSIZE
);

176 
p
->
ba£
 = ba£ + 
bm_∑ges
 * 
PGSIZE
;

177 
	}
}

181 
boﬁ


182 
	$∑ge_‰om_poﬁ
 (c⁄° 
poﬁ
 *poﬁ, *
∑ge
)

184 
size_t
 
∑ge_no
 = 
	`pg_no
 (
∑ge
);

185 
size_t
 
°¨t_∑ge
 = 
	`pg_no
 (
poﬁ
->
ba£
);

186 
size_t
 
íd_∑ge
 = 
°¨t_∑ge
 + 
	`bôm≠_size
 (
poﬁ
->
u£d_m≠
);

188  
∑ge_no
 >
°¨t_∑ge
 &&Öage_nÿ< 
íd_∑ge
;

189 
	}
}

	@palloc.h

1 #i‚de‡
THREADS_PALLOC_H


2 
	#THREADS_PALLOC_H


	)

4 
	~<°ddef.h
>

7 
	e∑Œoc_Êags


9 
	mPAL_ASSERT
 = 001,

10 
	mPAL_ZERO
 = 002,

11 
	mPAL_USER
 = 004

15 
size_t
 
u£r_∑ge_limô
;

17 
∑Œoc_öô
 ();

18 *
∑Œoc_gë_∑ge
 (
∑Œoc_Êags
);

19 *
∑Œoc_gë_mu…ùÀ
 (
∑Œoc_Êags
, 
size_t
 
∑ge_˙t
);

20 
∑Œoc_‰ì_∑ge
 (*);

21 
∑Œoc_‰ì_mu…ùÀ
 (*, 
size_t
 
∑ge_˙t
);

	@pte.h

1 #i‚de‡
THREADS_PTE_H


2 
	#THREADS_PTE_H


	)

4 
	~"thªads/vaddr.h
"

21 
	#PTSHIFT
 
PGBITS


	)

22 
	#PTBITS
 10

	)

23 
	#PTSPAN
 (1 << 
PTBITS
 << 
PGBITS
Ë

	)

24 
	#PTMASK
 
	`BITMASK
(
PTSHIFT
, 
PTBITS
Ë

	)

27 
	#PDSHIFT
 (
PTSHIFT
 + 
PTBITS
Ë

	)

28 
	#PDBITS
 10

	)

29 
	#PDMASK
 
	`BITMASK
(
PDSHIFT
, 
PDBITS
Ë

	)

32 
ölöe
 
	$±_no
 (c⁄° *
va
) {

33  ((
uöçå_t
Ë
va
 & 
PTMASK
Ë>> 
PTSHIFT
;

34 
	}
}

37 
ölöe
 
uöçå_t
 
	$pd_no
 (c⁄° *
va
) {

38  (
uöçå_t
Ë
va
 >> 
PDSHIFT
;

39 
	}
}

61 
	#PTE_FLAGS
 0x00000ff‡

	)

62 
	#PTE_ADDR
 0xfffff000

	)

63 
	#PTE_AVL
 0x00000e00

	)

64 
	#PTE_P
 0x1

	)

65 
	#PTE_W
 0x2

	)

66 
	#PTE_U
 0x4

	)

67 
	#PTE_A
 0x20

	)

68 
	#PTE_D
 0x40

	)

71 
ölöe
 
uöt32_t
 
	$pde_¸óã
 (
uöt32_t
 *
±
) {

72 
	`ASSERT
 (
	`pg_ofs
 (
±
) == 0);

73  
	`vt›
 (
±
Ë| 
PTE_U
 | 
PTE_P
 | 
PTE_W
;

74 
	}
}

78 
ölöe
 
uöt32_t
 *
	$pde_gë_±
 (
uöt32_t
 
pde
) {

79 
	`ASSERT
 (
pde
 & 
PTE_P
);

80  
	`±ov
 (
pde
 & 
PTE_ADDR
);

81 
	}
}

87 
ölöe
 
uöt32_t
 
	$±e_¸óã_kî√l
 (*
∑ge
, 
boﬁ
 
wrôabÀ
) {

88 
	`ASSERT
 (
	`pg_ofs
 (
∑ge
) == 0);

89  
	`vt›
 (
∑ge
Ë| 
PTE_P
 | (
wrôabÀ
 ? 
PTE_W
 : 0);

90 
	}
}

96 
ölöe
 
uöt32_t
 
	$±e_¸óã_u£r
 (*
∑ge
, 
boﬁ
 
wrôabÀ
) {

97  
	`±e_¸óã_kî√l
 (
∑ge
, 
wrôabÀ
Ë| 
PTE_U
;

98 
	}
}

102 
ölöe
 *
	$±e_gë_∑ge
 (
uöt32_t
 
±e
) {

103  
	`±ov
 (
±e
 & 
PTE_ADDR
);

104 
	}
}

	@switch.h

1 #i‚de‡
THREADS_SWITCH_H


2 
	#THREADS_SWITCH_H


	)

4 #i‚de‡
__ASSEMBLER__


6 
	sswôch_thªads_‰ame


8 
uöt32_t
 
	medi
;

9 
uöt32_t
 
	mesi
;

10 
uöt32_t
 
	mebp
;

11 
uöt32_t
 
	mebx
;

12 (*
	meù
) ();

13 
thªad
 *
	mcur
;

14 
thªad
 *
	m√xt
;

20 
thªad
 *
swôch_thªads
 (thªad *
cur
, thªad *
√xt
);

23 
	sswôch_íåy_‰ame


25 (*
	meù
) ();

28 
swôch_íåy
 ();

32 
swôch_thunk
 ();

36 
	#SWITCH_CUR
 20

	)

37 
	#SWITCH_NEXT
 24

	)

	@synch.c

29 
	~"thªads/synch.h
"

30 
	~<°dio.h
>

31 
	~<°rög.h
>

32 
	~"thªads/öãºu±.h
"

33 
	~"thªads/thªad.h
"

45 
	$£ma_öô
 (
£m≠h‹e
 *
£ma
, 
vÆue
)

47 
	`ASSERT
 (
£ma
 !
NULL
);

49 
£ma
->
vÆue
 = value;

50 
	`li°_öô
 (&
£ma
->
waôîs
);

51 
	}
}

61 
	$£ma_down
 (
£m≠h‹e
 *
£ma
)

63 
öå_Àvñ
 
ﬁd_Àvñ
;

65 
	`ASSERT
 (
£ma
 !
NULL
);

66 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

68 
ﬁd_Àvñ
 = 
	`öå_dißbÀ
 ();

69 
£ma
->
vÆue
 == 0)

71 
	`li°_push_back
 (&
£ma
->
waôîs
, &
	`thªad_cuºít
 ()->
ñem
);

72 
	`thªad_block
 ();

74 
£ma
->
vÆue
--;

75 
	`öå_£t_Àvñ
 (
ﬁd_Àvñ
);

76 
	}
}

83 
boﬁ


84 
	$£ma_åy_down
 (
£m≠h‹e
 *
£ma
)

86 
öå_Àvñ
 
ﬁd_Àvñ
;

87 
boﬁ
 
suc˚ss
;

89 
	`ASSERT
 (
£ma
 !
NULL
);

91 
ﬁd_Àvñ
 = 
	`öå_dißbÀ
 ();

92 i‡(
£ma
->
vÆue
 > 0)

94 
£ma
->
vÆue
--;

95 
suc˚ss
 = 
åue
;

98 
suc˚ss
 = 
Ál£
;

99 
	`öå_£t_Àvñ
 (
ﬁd_Àvñ
);

101  
suc˚ss
;

102 
	}
}

109 
	$£ma_up
 (
£m≠h‹e
 *
£ma
)

111 
öå_Àvñ
 
ﬁd_Àvñ
;

113 
	`ASSERT
 (
£ma
 !
NULL
);

115 
ﬁd_Àvñ
 = 
	`öå_dißbÀ
 ();

116 i‡(!
	`li°_em±y
 (&
£ma
->
waôîs
))

117 
	`thªad_unblock
 (
	`li°_íåy
 (
	`li°_p›_‰⁄t
 (&
£ma
->
waôîs
),

118 
thªad
, 
ñem
));

119 
£ma
->
vÆue
++;

120 
	`öå_£t_Àvñ
 (
ﬁd_Àvñ
);

121 
	}
}

123 
£ma_ã°_hñ≥r
 (*
£ma_
);

129 
	$£ma_£lf_ã°
 ()

131 
£m≠h‹e
 
£ma
[2];

132 
i
;

134 
	`¥ötf
 ("Testing semaphores...");

135 
	`£ma_öô
 (&
£ma
[0], 0);

136 
	`£ma_öô
 (&
£ma
[1], 0);

137 
	`thªad_¸óã
 ("£ma-ã°", 
PRI_DEFAULT
, 
£ma_ã°_hñ≥r
, &
£ma
);

138 
i
 = 0; i < 10; i++)

140 
	`£ma_up
 (&
£ma
[0]);

141 
	`£ma_down
 (&
£ma
[1]);

143 
	`¥ötf
 ("done.\n");

144 
	}
}

148 
	$£ma_ã°_hñ≥r
 (*
£ma_
)

150 
£m≠h‹e
 *
£ma
 = 
£ma_
;

151 
i
;

153 
i
 = 0; i < 10; i++)

155 
	`£ma_down
 (&
£ma
[0]);

156 
	`£ma_up
 (&
£ma
[1]);

158 
	}
}

176 
	$lock_öô
 (
lock
 *lock)

178 
	`ASSERT
 (
lock
 !
NULL
);

180 
lock
->
hﬁdî
 = 
NULL
;

181 
	`£ma_öô
 (&
lock
->
£m≠h‹e
, 1);

182 
	}
}

193 
	$lock_acquúe
 (
lock
 *lock)

195 
	`ASSERT
 (
lock
 !
NULL
);

196 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

197 
	`ASSERT
 (!
	`lock_hñd_by_cuºít_thªad
 (
lock
));

199 
	`£ma_down
 (&
lock
->
£m≠h‹e
);

200 
lock
->
hﬁdî
 = 
	`thªad_cuºít
 ();

201 
	}
}

209 
boﬁ


210 
	$lock_åy_acquúe
 (
lock
 *lock)

212 
boﬁ
 
suc˚ss
;

214 
	`ASSERT
 (
lock
 !
NULL
);

215 
	`ASSERT
 (!
	`lock_hñd_by_cuºít_thªad
 (
lock
));

217 
suc˚ss
 = 
	`£ma_åy_down
 (&
lock
->
£m≠h‹e
);

218 i‡(
suc˚ss
)

219 
lock
->
hﬁdî
 = 
	`thªad_cuºít
 ();

220  
suc˚ss
;

221 
	}
}

229 
	$lock_ªÀa£
 (
lock
 *lock)

231 
	`ASSERT
 (
lock
 !
NULL
);

232 
	`ASSERT
 (
	`lock_hñd_by_cuºít_thªad
 (
lock
));

234 
lock
->
hﬁdî
 = 
NULL
;

235 
	`£ma_up
 (&
lock
->
£m≠h‹e
);

236 
	}
}

241 
boﬁ


242 
	$lock_hñd_by_cuºít_thªad
 (c⁄° 
lock
 *lock)

244 
	`ASSERT
 (
lock
 !
NULL
);

246  
lock
->
hﬁdî
 =
	`thªad_cuºít
 ();

247 
	}
}

250 
	s£m≠h‹e_ñem


252 
li°_ñem
 
	mñem
;

253 
£m≠h‹e
 
	m£m≠h‹e
;

260 
	$c⁄d_öô
 (
c⁄dôi⁄
 *
c⁄d
)

262 
	`ASSERT
 (
c⁄d
 !
NULL
);

264 
	`li°_öô
 (&
c⁄d
->
waôîs
);

265 
	}
}

288 
	$c⁄d_waô
 (
c⁄dôi⁄
 *
c⁄d
, 
lock
 *lock)

290 
£m≠h‹e_ñem
 
waôî
;

292 
	`ASSERT
 (
c⁄d
 !
NULL
);

293 
	`ASSERT
 (
lock
 !
NULL
);

294 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

295 
	`ASSERT
 (
	`lock_hñd_by_cuºít_thªad
 (
lock
));

297 
	`£ma_öô
 (&
waôî
.
£m≠h‹e
, 0);

298 
	`li°_push_back
 (&
c⁄d
->
waôîs
, &
waôî
.
ñem
);

299 
	`lock_ªÀa£
 (
lock
);

300 
	`£ma_down
 (&
waôî
.
£m≠h‹e
);

301 
	`lock_acquúe
 (
lock
);

302 
	}
}

312 
	$c⁄d_sig«l
 (
c⁄dôi⁄
 *
c⁄d
, 
lock
 *lock 
UNUSED
)

314 
	`ASSERT
 (
c⁄d
 !
NULL
);

315 
	`ASSERT
 (
lock
 !
NULL
);

316 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

317 
	`ASSERT
 (
	`lock_hñd_by_cuºít_thªad
 (
lock
));

319 i‡(!
	`li°_em±y
 (&
c⁄d
->
waôîs
))

320 
	`£ma_up
 (&
	`li°_íåy
 (
	`li°_p›_‰⁄t
 (&
c⁄d
->
waôîs
),

321 
£m≠h‹e_ñem
, 
ñem
)->
£m≠h‹e
);

322 
	}
}

331 
	$c⁄d_brﬂdˇ°
 (
c⁄dôi⁄
 *
c⁄d
, 
lock
 *lock)

333 
	`ASSERT
 (
c⁄d
 !
NULL
);

334 
	`ASSERT
 (
lock
 !
NULL
);

336 !
	`li°_em±y
 (&
c⁄d
->
waôîs
))

337 
	`c⁄d_sig«l
 (
c⁄d
, 
lock
);

338 
	}
}

	@synch.h

1 #i‚de‡
THREADS_SYNCH_H


2 
	#THREADS_SYNCH_H


	)

4 
	~<li°.h
>

5 
	~<°dboﬁ.h
>

8 
	s£m≠h‹e


10 
	mvÆue
;

11 
li°
 
	mwaôîs
;

14 
£ma_öô
 (
£m≠h‹e
 *, 
vÆue
);

15 
£ma_down
 (
£m≠h‹e
 *);

16 
boﬁ
 
£ma_åy_down
 (
£m≠h‹e
 *);

17 
£ma_up
 (
£m≠h‹e
 *);

18 
£ma_£lf_ã°
 ();

21 
	slock


23 
thªad
 *
	mhﬁdî
;

24 
£m≠h‹e
 
	m£m≠h‹e
;

27 
lock_öô
 (
lock
 *);

28 
lock_acquúe
 (
lock
 *);

29 
boﬁ
 
lock_åy_acquúe
 (
lock
 *);

30 
lock_ªÀa£
 (
lock
 *);

31 
boﬁ
 
lock_hñd_by_cuºít_thªad
 (c⁄° 
lock
 *);

34 
	sc⁄dôi⁄


36 
li°
 
	mwaôîs
;

39 
c⁄d_öô
 (
c⁄dôi⁄
 *);

40 
c⁄d_waô
 (
c⁄dôi⁄
 *, 
lock
 *);

41 
c⁄d_sig«l
 (
c⁄dôi⁄
 *, 
lock
 *);

42 
c⁄d_brﬂdˇ°
 (
c⁄dôi⁄
 *, 
lock
 *);

49 
	#b¨rõr
(Ë
asm
 vﬁ©ûê("" : : : "mem‹y")

	)

	@thread.c

1 
	~"thªads/thªad.h
"

2 
	~<debug.h
>

3 
	~<°ddef.h
>

4 
	~<øndom.h
>

5 
	~<°dio.h
>

6 
	~<°rög.h
>

7 
	~"thªads/Êags.h
"

8 
	~"thªads/öãºu±.h
"

9 
	~"thªads/öå-°ubs.h
"

10 
	~"thªads/∑Œoc.h
"

11 
	~"thªads/swôch.h
"

12 
	~"thªads/synch.h
"

13 
	~"thªads/vaddr.h
"

14 #ifde‡
USERPROG


15 
	~"u£Ωrog/¥o˚ss.h
"

21 
	#THREAD_MAGIC
 0xcd6abf4b

	)

25 
li°
 
	gªady_li°
;

29 
li°
 
	gÆl_li°
;

32 
thªad
 *
	gidÀ_thªad
;

35 
thªad
 *
	göôül_thªad
;

38 
lock
 
	gtid_lock
;

41 
	skî√l_thªad_‰ame


43 *
	meù
;

44 
thªad_func
 *
	mfun˘i⁄
;

45 *
	maux
;

49 
	gidÀ_ticks
;

50 
	gkî√l_ticks
;

51 
	gu£r_ticks
;

54 
	#TIME_SLICE
 4

	)

55 
	gthªad_ticks
;

60 
boﬁ
 
	gthªad_mlfqs
;

62 
kî√l_thªad
 (
thªad_func
 *, *
aux
);

64 
idÀ
 (*
aux
 
UNUSED
);

65 
thªad
 *
ru¬ög_thªad
 ();

66 
thªad
 *
√xt_thªad_to_run
 ();

67 
öô_thªad
 (
thªad
 *, c⁄° *
«me
, 
¥i‹ôy
);

68 
boﬁ
 
	$is_thªad
 (
thªad
 *Ë
UNUSED
;

69 *
	`Æloc_‰ame
 (
thªad
 *, 
size_t
 
size
);

70 
	`scheduÀ
 ();

71 
	`scheduÀ_èû
 (
thªad
 *
¥ev
);

72 
tid_t
 
	`Æloˇã_tid
 ();

88 
	$thªad_öô
 ()

90 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

92 
	`lock_öô
 (&
tid_lock
);

93 
	`li°_öô
 (&
ªady_li°
);

94 
	`li°_öô
 (&
Æl_li°
);

97 
öôül_thªad
 = 
	`ru¬ög_thªad
 ();

98 
	`öô_thªad
 (
öôül_thªad
, "maö", 
PRI_DEFAULT
);

99 
öôül_thªad
->
°©us
 = 
THREAD_RUNNING
;

100 
öôül_thªad
->
tid
 = 
	`Æloˇã_tid
 ();

101 
	}
}

106 
	$thªad_°¨t
 ()

109 
£m≠h‹e
 
idÀ_°¨ãd
;

110 
	`£ma_öô
 (&
idÀ_°¨ãd
, 0);

111 
	`thªad_¸óã
 ("idÀ", 
PRI_MIN
, 
idÀ
, &
idÀ_°¨ãd
);

114 
	`öå_íabÀ
 ();

117 
	`£ma_down
 (&
idÀ_°¨ãd
);

118 
	}
}

123 
	$thªad_tick
 ()

125 
thªad
 *
t
 = 
	`thªad_cuºít
 ();

128 i‡(
t
 =
idÀ_thªad
)

129 
idÀ_ticks
++;

130 #ifde‡
USERPROG


131 i‡(
t
->
∑gedú
 !
NULL
)

132 
u£r_ticks
++;

135 
kî√l_ticks
++;

138 i‡(++
thªad_ticks
 >
TIME_SLICE
)

139 
	`öå_yõld_⁄_ªtu∫
 ();

140 
	}
}

144 
	$thªad_¥öt_°©s
 ()

146 
	`¥ötf
 ("Thread: %lld idleÅicks, %lld kernelÅicks, %lld userÅicks\n",

147 
idÀ_ticks
, 
kî√l_ticks
, 
u£r_ticks
);

148 
	}
}

165 
tid_t


166 
	$thªad_¸óã
 (c⁄° *
«me
, 
¥i‹ôy
,

167 
thªad_func
 *
fun˘i⁄
, *
aux
)

169 
thªad
 *
t
;

170 
kî√l_thªad_‰ame
 *
kf
;

171 
swôch_íåy_‰ame
 *
ef
;

172 
swôch_thªads_‰ame
 *
sf
;

173 
tid_t
 
tid
;

174 
öå_Àvñ
 
ﬁd_Àvñ
;

176 
	`ASSERT
 (
fun˘i⁄
 !
NULL
);

179 
t
 = 
	`∑Œoc_gë_∑ge
 (
PAL_ZERO
);

180 i‡(
t
 =
NULL
)

181  
TID_ERROR
;

184 
	`öô_thªad
 (
t
, 
«me
, 
¥i‹ôy
);

185 
tid
 = 
t
->tid = 
	`Æloˇã_tid
 ();

190 
ﬁd_Àvñ
 = 
	`öå_dißbÀ
 ();

193 
kf
 = 
	`Æloc_‰ame
 (
t
,  *kf);

194 
kf
->
eù
 = 
NULL
;

195 
kf
->
fun˘i⁄
 = function;

196 
kf
->
aux
 =áux;

199 
ef
 = 
	`Æloc_‰ame
 (
t
,  *ef);

200 
ef
->
eù
 = ((*Ë()Ë
kî√l_thªad
;

203 
sf
 = 
	`Æloc_‰ame
 (
t
,  *sf);

204 
sf
->
eù
 = 
swôch_íåy
;

205 
sf
->
ebp
 = 0;

207 
	`öå_£t_Àvñ
 (
ﬁd_Àvñ
);

210 
	`thªad_unblock
 (
t
);

212  
tid
;

213 
	}
}

222 
	$thªad_block
 ()

224 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

225 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

227 
	`thªad_cuºít
 ()->
°©us
 = 
THREAD_BLOCKED
;

228 
	`scheduÀ
 ();

229 
	}
}

240 
	$thªad_unblock
 (
thªad
 *
t
)

242 
öå_Àvñ
 
ﬁd_Àvñ
;

244 
	`ASSERT
 (
	`is_thªad
 (
t
));

246 
ﬁd_Àvñ
 = 
	`öå_dißbÀ
 ();

247 
	`ASSERT
 (
t
->
°©us
 =
THREAD_BLOCKED
);

248 
	`li°_push_back
 (&
ªady_li°
, &
t
->
ñem
);

249 
t
->
°©us
 = 
THREAD_READY
;

250 
	`öå_£t_Àvñ
 (
ﬁd_Àvñ
);

251 
	}
}

255 
	$thªad_«me
 ()

257  
	`thªad_cuºít
 ()->
«me
;

258 
	}
}

263 
thªad
 *

264 
	$thªad_cuºít
 ()

266 
thªad
 *
t
 = 
	`ru¬ög_thªad
 ();

273 
	`ASSERT
 (
	`is_thªad
 (
t
));

274 
	`ASSERT
 (
t
->
°©us
 =
THREAD_RUNNING
);

276  
t
;

277 
	}
}

280 
tid_t


281 
	$thªad_tid
 ()

283  
	`thªad_cuºít
 ()->
tid
;

284 
	}
}

289 
	$thªad_exô
 ()

291 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

293 #ifde‡
USERPROG


294 
	`¥o˚ss_exô
 ();

300 
	`öå_dißbÀ
 ();

301 
	`li°_ªmove
 (&
	`thªad_cuºít
()->
ÆÀÀm
);

302 
	`thªad_cuºít
 ()->
°©us
 = 
THREAD_DYING
;

303 
	`scheduÀ
 ();

304 
	`NOT_REACHED
 ();

305 
	}
}

310 
	$thªad_yõld
 ()

312 
thªad
 *
cur
 = 
	`thªad_cuºít
 ();

313 
öå_Àvñ
 
ﬁd_Àvñ
;

315 
	`ASSERT
 (!
	`öå_c⁄ãxt
 ());

317 
ﬁd_Àvñ
 = 
	`öå_dißbÀ
 ();

318 i‡(
cur
 !
idÀ_thªad
)

319 
	`li°_push_back
 (&
ªady_li°
, &
cur
->
ñem
);

320 
cur
->
°©us
 = 
THREAD_READY
;

321 
	`scheduÀ
 ();

322 
	`öå_£t_Àvñ
 (
ﬁd_Àvñ
);

323 
	}
}

328 
	$thªad_f‹óch
 (
thªad_a˘i⁄_func
 *
func
, *
aux
)

330 
li°_ñem
 *
e
;

332 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

334 
e
 = 
	`li°_begö
 (&
Æl_li°
);É !
	`li°_íd
 (&all_list);

335 
e
 = 
	`li°_√xt
 (e))

337 
thªad
 *
t
 = 
	`li°_íåy
 (
e
, thªad, 
ÆÀÀm
);

338 
	`func
 (
t
, 
aux
);

340 
	}
}

344 
	$thªad_£t_¥i‹ôy
 (
√w_¥i‹ôy
)

346 
	`thªad_cuºít
 ()->
¥i‹ôy
 = 
√w_¥i‹ôy
;

347 
	}
}

351 
	$thªad_gë_¥i‹ôy
 ()

353  
	`thªad_cuºít
 ()->
¥i‹ôy
;

354 
	}
}

358 
	$thªad_£t_ni˚
 (
ni˚
 
UNUSED
)

361 
	}
}

365 
	$thªad_gë_ni˚
 ()

369 
	}
}

373 
	$thªad_gë_lﬂd_avg
 ()

377 
	}
}

381 
	$thªad_gë_ª˚¡_˝u
 ()

385 
	}
}

397 
	$idÀ
 (*
idÀ_°¨ãd_
 
UNUSED
)

399 
£m≠h‹e
 *
idÀ_°¨ãd
 = 
idÀ_°¨ãd_
;

400 
idÀ_thªad
 = 
	`thªad_cuºít
 ();

401 
	`£ma_up
 (
idÀ_°¨ãd
);

406 
	`öå_dißbÀ
 ();

407 
	`thªad_block
 ();

421 
asm
 volatile ("sti; hlt" : : : "memory");

423 
	}
}

427 
	$kî√l_thªad
 (
thªad_func
 *
fun˘i⁄
, *
aux
)

429 
	`ASSERT
 (
fun˘i⁄
 !
NULL
);

431 
	`öå_íabÀ
 ();

432 
	`fun˘i⁄
 (
aux
);

433 
	`thªad_exô
 ();

434 
	}
}

437 
thªad
 *

438 
	$ru¬ög_thªad
 ()

440 
uöt32_t
 *
e•
;

446 
	`asm
 ("mov %%e•, %0" : "=g" (
e•
));

447  
	`pg_round_down
 (
e•
);

448 
	}
}

451 
boﬁ


452 
	$is_thªad
 (
thªad
 *
t
)

454  
t
 !
NULL
 &&Å->
magic
 =
THREAD_MAGIC
;

455 
	}
}

460 
	$öô_thªad
 (
thªad
 *
t
, c⁄° *
«me
, 
¥i‹ôy
)

462 
	`ASSERT
 (
t
 !
NULL
);

463 
	`ASSERT
 (
PRI_MIN
 <
¥i‹ôy
 &&Öri‹ôy <
PRI_MAX
);

464 
	`ASSERT
 (
«me
 !
NULL
);

466 
	`mem£t
 (
t
, 0,  *t);

467 
t
->
°©us
 = 
THREAD_BLOCKED
;

468 
	`°æ˝y
 (
t
->
«me
,Çame, Å->name);

469 
t
->
°ack
 = (
uöt8_t
 *Ëà+ 
PGSIZE
;

470 
t
->
¥i‹ôy
 =Öriority;

471 
t
->
magic
 = 
THREAD_MAGIC
;

472 
	`li°_push_back
 (&
Æl_li°
, &
t
->
ÆÀÀm
);

473 
	}
}

478 
	$Æloc_‰ame
 (
thªad
 *
t
, 
size_t
 
size
)

481 
	`ASSERT
 (
	`is_thªad
 (
t
));

482 
	`ASSERT
 (
size
 %  (
uöt32_t
) == 0);

484 
t
->
°ack
 -
size
;

485  
t
->
°ack
;

486 
	}
}

493 
thªad
 *

494 
	$√xt_thªad_to_run
 ()

496 i‡(
	`li°_em±y
 (&
ªady_li°
))

497  
idÀ_thªad
;

499  
	`li°_íåy
 (
	`li°_p›_‰⁄t
 (&
ªady_li°
), 
thªad
, 
ñem
);

500 
	}
}

519 
	$scheduÀ_èû
 (
thªad
 *
¥ev
)

521 
thªad
 *
cur
 = 
	`ru¬ög_thªad
 ();

523 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

526 
cur
->
°©us
 = 
THREAD_RUNNING
;

529 
thªad_ticks
 = 0;

531 #ifde‡
USERPROG


533 
	`¥o˚ss_a˘iv©e
 ();

541 i‡(
¥ev
 !
NULL
 &&Öªv->
°©us
 =
THREAD_DYING
 &&Öªv !
öôül_thªad
)

543 
	`ASSERT
 (
¥ev
 !
cur
);

544 
	`∑Œoc_‰ì_∑ge
 (
¥ev
);

546 
	}
}

556 
	$scheduÀ
 ()

558 
thªad
 *
cur
 = 
	`ru¬ög_thªad
 ();

559 
thªad
 *
√xt
 = 
	`√xt_thªad_to_run
 ();

560 
thªad
 *
¥ev
 = 
NULL
;

562 
	`ASSERT
 (
	`öå_gë_Àvñ
 (Ë=
INTR_OFF
);

563 
	`ASSERT
 (
cur
->
°©us
 !
THREAD_RUNNING
);

564 
	`ASSERT
 (
	`is_thªad
 (
√xt
));

566 i‡(
cur
 !
√xt
)

567 
¥ev
 = 
	`swôch_thªads
 (
cur
, 
√xt
);

568 
	`scheduÀ_èû
 (
¥ev
);

569 
	}
}

572 
tid_t


573 
	$Æloˇã_tid
 ()

575 
tid_t
 
√xt_tid
 = 1;

576 
tid_t
 
tid
;

578 
	`lock_acquúe
 (&
tid_lock
);

579 
tid
 = 
√xt_tid
++;

580 
	`lock_ªÀa£
 (&
tid_lock
);

582  
tid
;

583 
	}
}

587 
uöt32_t
 
	gthªad_°ack_ofs
 = 
off£tof
 (
thªad
, 
°ack
);

	@thread.h

1 #i‚de‡
THREADS_THREAD_H


2 
	#THREADS_THREAD_H


	)

4 
	~<debug.h
>

5 
	~<li°.h
>

6 
	~<°döt.h
>

9 
	ethªad_°©us


11 
	mTHREAD_RUNNING
,

12 
	mTHREAD_READY
,

13 
	mTHREAD_BLOCKED
,

14 
	mTHREAD_DYING


19 
	ttid_t
;

20 
	#TID_ERROR
 ((
tid_t
Ë-1Ë

	)

23 
	#PRI_MIN
 0

	)

24 
	#PRI_DEFAULT
 31

	)

25 
	#PRI_MAX
 63

	)

83 
	sthªad


86 
tid_t
 
	mtid
;

87 
thªad_°©us
 
	m°©us
;

88 
	m«me
[16];

89 
uöt8_t
 *
	m°ack
;

90 
	m¥i‹ôy
;

91 
li°_ñem
 
	mÆÀÀm
;

94 
li°_ñem
 
	mñem
;

96 #ifde‡
USERPROG


98 
uöt32_t
 *
	m∑gedú
;

102 
	mmagic
;

108 
boﬁ
 
thªad_mlfqs
;

110 
thªad_öô
 ();

111 
thªad_°¨t
 ();

113 
thªad_tick
 ();

114 
thªad_¥öt_°©s
 ();

116 
	tthªad_func
 (*
	taux
);

117 
tid_t
 
thªad_¸óã
 (c⁄° *
«me
, 
¥i‹ôy
, 
thªad_func
 *, *);

119 
thªad_block
 ();

120 
thªad_unblock
 (
thªad
 *);

122 
thªad
 *
thªad_cuºít
 ();

123 
tid_t
 
thªad_tid
 ();

124 c⁄° *
thªad_«me
 ();

126 
	$thªad_exô
 (Ë
NO_RETURN
;

127 
	`thªad_yõld
 ();

130 
	tthªad_a˘i⁄_func
 (
	tthªad
 *
	tt
, *
	taux
);

131 
	`thªad_f‹óch
 (
thªad_a˘i⁄_func
 *, *);

133 
	`thªad_gë_¥i‹ôy
 ();

134 
	`thªad_£t_¥i‹ôy
 ();

136 
	`thªad_gë_ni˚
 ();

137 
	`thªad_£t_ni˚
 ();

138 
	`thªad_gë_ª˚¡_˝u
 ();

139 
	`thªad_gë_lﬂd_avg
 ();

	@vaddr.h

1 #i‚de‡
THREADS_VADDR_H


2 
	#THREADS_VADDR_H


	)

4 
	~<debug.h
>

5 
	~<°döt.h
>

6 
	~<°dboﬁ.h
>

8 
	~"thªads/lﬂdî.h
"

15 
	#BITMASK
(
SHIFT
, 
CNT
Ë(((1u»<< (CNT)Ë- 1Ë<< (SHIFT))

	)

18 
	#PGSHIFT
 0

	)

19 
	#PGBITS
 12

	)

20 
	#PGSIZE
 (1 << 
PGBITS
Ë

	)

21 
	#PGMASK
 
	`BITMASK
(
PGSHIFT
, 
PGBITS
Ë

	)

24 
ölöe
 
	$pg_ofs
 (c⁄° *
va
) {

25  (
uöçå_t
Ë
va
 & 
PGMASK
;

26 
	}
}

29 
ölöe
 
uöçå_t
 
	$pg_no
 (c⁄° *
va
) {

30  (
uöçå_t
Ë
va
 >> 
PGBITS
;

31 
	}
}

34 
ölöe
 *
	$pg_round_up
 (c⁄° *
va
) {

35  (*Ë(((
uöçå_t
Ë
va
 + 
PGSIZE
 - 1Ë& ~
PGMASK
);

36 
	}
}

39 
ölöe
 *
	$pg_round_down
 (c⁄° *
va
) {

40  (*Ë((
uöçå_t
Ë
va
 & ~
PGMASK
);

41 
	}
}

53 
	#PHYS_BASE
 ((*Ë
LOADER_PHYS_BASE
)

	)

56 
ölöe
 
boﬁ


57 
	$is_u£r_vaddr
 (c⁄° *
vaddr
)

59  
vaddr
 < 
PHYS_BASE
;

60 
	}
}

63 
ölöe
 
boﬁ


64 
	$is_kî√l_vaddr
 (c⁄° *
vaddr
)

66  
vaddr
 >
PHYS_BASE
;

67 
	}
}

71 
ölöe
 *

72 
	$±ov
 (
uöçå_t
 
∑ddr
)

74 
	`ASSERT
 ((*Ë
∑ddr
 < 
PHYS_BASE
);

76  (*Ë(
∑ddr
 + 
PHYS_BASE
);

77 
	}
}

81 
ölöe
 
uöçå_t


82 
	$vt›
 (c⁄° *
vaddr
)

84 
	`ASSERT
 (
	`is_kî√l_vaddr
 (
vaddr
));

86  (
uöçå_t
Ë
vaddr
 - (uöçå_tË
PHYS_BASE
;

87 
	}
}

	@
1
.
0
19
166
flags.h
init.c
init.h
interrupt.c
interrupt.h
intr-stubs.h
io.h
loader.h
malloc.c
malloc.h
palloc.c
palloc.h
pte.h
switch.h
synch.c
synch.h
thread.c
thread.h
vaddr.h
